input {
  syslog { 
    port => 514 
    type => "syslog"
  }
  tcp { 
    port => 5000 
    codec => json_lines 
    tags => ["tcp", "json"] 
    type => "tcp_json"
  }
}

filter {
  mutate {
    add_field => { 
      "processed_at" => "%{@timestamp}"
      "homelab_version" => "1.0"
      "pipeline" => "main"
    }
  }

  if "syslog" in [tags] or [type] == "syslog" {
    mutate { add_field => { "log_type" => "syslog" } }
    
    grok {
      match => { 
        "message" => "%{SYSLOGTIMESTAMP:timestamp} %{IPORHOST:host} %{DATA:program}(?:\\[%{POSINT:pid}\\])?: %{GREEDYDATA:log_message}"
      }
    }
    
    if [program] =~ /(?i)pve|proxmox/ or [host] =~ /(?i)pve|proxmox/ {
      mutate { 
        add_field => { "device_type" => "proxmox" }
        add_tag => ["proxmox"] 
      }
    } else {
      mutate { add_field => { "device_type" => "network" } }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "homelab-logs-%{[device_type]}-%{+YYYY.MM.dd}"
  }
}
