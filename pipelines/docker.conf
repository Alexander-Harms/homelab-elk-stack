# Docker pipeline - handles container logs from Filebeat and GELF
input {
  beats { 
    port => 5044 
    type => "beats"
  }
  
  gelf { 
    port => 12201 
    tags => ["gelf", "docker"] 
    type => "gelf"
  }
}

filter {
  # Add common fields
  mutate {
    add_field => { 
      "processed_at" => "%{@timestamp}"
      "homelab_version" => "1.0"
      "pipeline" => "docker"
    }
  }

  # Handle Filebeat container logs
  if [agent][type] == "filebeat" or "beats" in [tags] {
    mutate { 
      add_field => { 
        "log_type" => "docker"
        "device_type" => "docker"
        "source_category" => "containers"
        "[service][type]" => "container"
      }
      add_tag => ["docker", "filebeat"]
    }
    
    if [container][name] {
      mutate { 
        add_field => { "[service][name]" => "%{[container][name]}" }
      }
    } else {
      mutate {
        add_field => { "[service][name]" => "docker-unknown" }
      }
    }
  }
  
  # Handle GELF logs directly from Docker
  if "gelf" in [tags] or [type] == "gelf" {
    mutate { 
      add_field => { 
        "log_type" => "docker" 
        "source_category" => "containers"
        "device_type" => "docker"
        "[service][type]" => "container"
      }
      add_tag => ["docker", "gelf"]
    }
    
    if [container_name] {
      mutate { 
        add_field => { "[service][name]" => "%{container_name}" }
      }
    } else {
      mutate {
        add_field => { "[service][name]" => "gelf-unknown" }
      }
    }
  }

  # Clean up
  mutate {
    remove_field => [ "agent", "ecs", "input", "@version" ]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "homelab-logs-%{[device_type]}-%{+YYYY.MM.dd}"
  }
}
